<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/voyent-web-components/voyent-location-editor/voyent-location-editor.html">
<link rel="import" href="shared-styles.html">

<dom-module id="map-view">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }
            #mapContainer{
                height: var(--height-var);
            }
        </style>

        <div id="mapContainer" style="width:100%;">
            <div id="map" style="height:100%;width:100%"></div>
        </div>
    </template>

    <script>
        var _this;
        Polymer({
            is: 'map-view',
            
            properties: {
                visible: {
                    type: Boolean,
                    value: false,
                    observer: 'visibleChanged'
                },
                height: { type: Number,
                    value: 500,
                    notify: true
                },
                zones: {
                    type:Array,
                    value:[]
                },
                user: {type:Object},
                trackers: {type:Object}
            },
            
            ready: function() {
                _this = this;
                _this.customStyle['--height-var'] = _this.height + 'px';
                _this.updateStyles();
                window.addEventListener("resize", function() {
                    _this.calcHeight();
                });

                window.initializeLocationsMap = function () {
                    var start = {lat: 0, lng: 0};
                    var map = new google.maps.Map(document.getElementById('map'), {
                        zoom: 4,
                        center: start
                    });
                    _this.map = map;
                    _this.getLocations(true);
                };
                if (!('google' in window) || !('maps' in window.google)) {
                    var script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyAZVsIO4CmSqqE7qbSO8pB0JPVUkO5bOd8&v=3.25&' +
                            'libraries=places,geometry,visualization,drawing&callback=initializeLocationsMap';
                    _this.$.mapContainer.appendChild(script);
                }
                else {
                    initializeLocationsMap();
                }
            },
            
            attached: function() {
                this.calcHeight();
            },
            
            calcHeight: function() {
                var h = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
                
                if (document.getElementById("mainHeader")) {
                    var headerHeight = document.getElementById("mainHeader").clientHeight;
                    if (headerHeight) {
                        h -= headerHeight;
                    }
                }

                _this.set("height", h);
                _this.customStyle['--height-var'] = h + 'px';
                _this.updateStyles();
            },

            visibleChanged:function(){
                if(this.visible) {
                    function waitForPushConnection() {
                        if (!voyent.xio.push.connected) {
                            setTimeout(waitForPushConnection, 100);
                            return;
                        }
                        voyent.xio.push.join('trackerMove');
                    }

                    waitForPushConnection();
                }
                else{
                    voyent.xio.push.leave('trackerMove');
                }
            },

            getLocations:function(resetMap){
                var promises = [];
                var trackers;
                var location;
                _this.oldUser = _this.user;
                //_this.oldAnchor = _this.anchor;
                //_this.oldZones = _this.zones;
                _this.zones = [];
                _this.trackers = {};
                promises.push(voyent.io.locate.getAllTrackers({realm:_this.realm}).then(function (t) {
                    trackers = t;
                    console.log(trackers);
                }));

                promises.push(voyent.io.locate.findLocations({realm:voyent.io.auth.getLastKnownRealm(),'query':{'username':voyent.io.auth.getLastKnownUsername()}, 'options':{"sort":{"lastUpdated":-1},"limit":1}}).then(function(l){
                    location = l[0];
                }));
                //promises.push(voyent.io.locate.getLastUserLocation({'username':voyent.io.auth.getLastKnownUsername()}).then(function(l){
                //    console.log(voyent.io.auth.getLastKnownUsername());
                //    console.log('Found person');
                //        console.log(l)
                //    }));
                //Use getLastUserLocation? promises.push(voyent.io.locate.getLastUserLocation)
                return Promise.all(promises).then(function () {
                    var locationPromises = [];
                    var locations = {};
                    for (var j = 0; j < trackers.length; j++){
                        locationPromises.push(voyent.io.locate.getLastUserLocation({realm:_this.realm,username:trackers[j]._id}).then(function(l){
                            locations[l.username] = l;
                        }));
                    }
                    return Promise.all(locationPromises).then(function(){
                        var bounds = new google.maps.LatLngBounds();
                        if(_this.oldUser){
                            _this.oldUser.setMap(null)
                        }
                        /**if(_this.oldAnchor){
                            _this.oldAnchor.setMap(null);
                        }
                        for(var i = 0; i < _this.oldZones.length; i++){
                            _this.oldZones[i].setMap(null);
                        }*/
                        for (i = 0; i < trackers.length; i++) {
                            try {

                                var anchorCoords = trackers[i].anchor.geometry.coordinates;
                                var googlePoint;
                                var lastKnownTrackerLocation = locations[trackers[i]._id];
                                if (lastKnownTrackerLocation) {
                                    googlePoint = new google.maps.LatLng(lastKnownTrackerLocation.location.geometry.coordinates[1],
                                            lastKnownTrackerLocation.location.geometry.coordinates[0]);
                                }
                                else {
                                    googlePoint = new google.maps.LatLng(anchorCoords[1], anchorCoords[0]);
                                }
                                poi = new google.maps.Marker({
                                    position: googlePoint,
                                    map: _this.map,
                                    draggable: false,
                                    zIndex: trackers[i].anchor.properties.zIndex
                                });
                                _this.anchor = poi;

                                bounds.extend(googlePoint);
                                var geoJSON = trackers[i];

                                var zones = [];
                                for(var j = 0; j < geoJSON.zones.features.length; j++){

                                    var zone = geoJSON.zones.features[j];
                                    var metadata = zone.properties.googleMaps;
                                    var region = new google.maps.Circle({
                                        'center': googlePoint,
                                        'radius': metadata.radius,
                                        'map': _this.map,
                                        'editable': false,
                                        'fillColor': zone.properties.Color,
                                        'zIndex': metadata.zIndex
                                    });
                                    zones.push(region);
                                    region.bindTo('center', poi, 'position');
                                }
                                if (!geoJSON.properties.zoneNamespace) {
                                    geoJSON.properties.zoneNamespace = 'default';
                                }
                                _this.trackers[trackers[i]._id] = {'anchor':poi,'zones':zones};

                            }
                            catch (err) {
                                this.fire('message-error', "Issue importing tracker: " + JSON.stringify(data[i]), err);
                            }
                        }
                        googlePoint = new google.maps.LatLng(location.location.geometry.coordinates[1], location.location.geometry.coordinates[0]);
                        var poi;
                        poi = new google.maps.Marker({
                            position: googlePoint,
                            map: _this.map,
                            draggable: false,
                            icon: 'images/user.png'
                        });
                        _this.user = poi;
                        bounds.extend(googlePoint);

                        if(resetMap){
                            _this.map.fitBounds(bounds);
                            _this.map.panToBounds(bounds);
                            _this.map.setZoom(_this.map.getZoom()-3);
                        }
                    });

                })['catch'](function (error) {
                    console.log('<voyent-locations> Error: ' + ( error.message || error.responseText));
                    console.log(error);
                });
            },
            moveLocations:function(event){
                var payload = JSON.parse(event.detail.notification.payload);
                var newLocation = new google.maps.LatLng({lat:payload.location[1],lng:payload.location[0]});
                _this.trackers[payload.trackerId].anchor.setPosition(newLocation);
            }
        });
    </script>
</dom-module>
