<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/voyent-web-components/voyent-location-editor/voyent-location-editor.html">
<link rel="import" href="shared-styles.html">

<dom-module id="map-view">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }
            #mapContainer{
                height: var(--height-var)
            }
        </style>

        <div id="mapContainer" style="width:100%;">
            <div id="map" style="height:100%;width:100%"></div>
        </div>
    </template>

    <script>
        var _this;
        Polymer({
            is: 'map-view',
            
            properties: {
                visible: {
                    type: Boolean,
                    value: false,
                    observer: 'visibleChanged'
                },
                height: { type: Number,
                    value: 500,
                    notify: true
                },
                zones: {
                    type:Array,
                    value:[]
                },
                user: {type:Object}
            },
            
            ready: function() {
                _this = this;
                _this.customStyle['--height-var'] = _this.height + 'px';
                _this.updateStyles();
                window.addEventListener("resize", function() {
                    _this.calcHeight();
                });
                document.addEventListener('beforeQueueUpdated',function(e) {
                    console.log('IN LISTENER');
                    console.log(e);
                    e.preventDefault();
                });
                window.initializeLocationsMap = function () {
                    var start = {lat: 0, lng: 0};
                    var map = new google.maps.Map(document.getElementById('map'), {
                        zoom: 4,
                        center: start
                    });
                    _this.map = map;
                    _this.updateLocations();
                };
                if (!('google' in window) || !('maps' in window.google)) {
                    var script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyAZVsIO4CmSqqE7qbSO8pB0JPVUkO5bOd8&v=3.25&' +
                            'libraries=places,geometry,visualization,drawing&callback=initializeLocationsMap';
                    _this.$.mapContainer.appendChild(script);
                }
                else {
                    initializeLocationsMap();
                }
            },
            
            attached: function() {
                this.calcHeight();
            },
            
            calcHeight: function() {
                var h = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
                
                if (document.getElementById("mainHeader")) {
                    var headerHeight = document.getElementById("mainHeader").clientHeight;
                    if (headerHeight) {
                        h -= headerHeight;
                    }
                }
                
                console.log("Setting map height to " + h);
                _this.set("height", h);
                _this.customStyle['--height-var'] = h + 'px';
                _this.updateStyles();
            },

            visibleChanged:function(){
                if(this.visible){
                    voyent.xio.push.join('trackerMove');
                }
                else{
                    voyent.xio.push.leave('trackerMove');
                }
            },

            updateLocations:function(){
                var promises = [];
                var trackers;
                var location;
                if(_this.user){
                    _this.user.setMap(null)
                }
                if(_this.anchor){
                    _this.anchor.setMap(null);
                }
                for(var i = 0; i < _this.zones.length; i++){
                    _this.zones[i].setMap(null);
                }
                _this.zones = [];
                promises.push(voyent.io.locate.getAllTrackers({realm:voyent.io.auth.getLastKnownRealm()}).then(function (t) {
                    trackers = t;
                }));
                promises.push(voyent.io.locate.findPOIs({realm:voyent.io.auth.getLastKnownRealm(),'query':{'label':voyent.io.auth.getLastKnownUsername()}}).then(function(l){
                    location = l[0];
                }));
                promises.push(voyent.io.locate.getLastUserLocation({'username':voyent.io.auth.getLastKnownUsername()}).then(function(l){
                    console.log(voyent.io.auth.getLastKnownUsername());
                    console.log('Found person');
                        console.log(l)
                    }));
                //Use getLastUserLocation? promises.push(voyent.io.locate.getLastUserLocation)
                return Promise.all(promises).then(function () {
                    var bounds = new google.maps.LatLngBounds();
                    for (var i = 0; i < trackers.length; i++) {
                        try {

                            var anchorCoords = trackers[i].anchor.geometry.coordinates;
                            var googlePoint = new google.maps.LatLng(anchorCoords[1], anchorCoords[0]);
                            poi = new google.maps.Marker({
                                position: googlePoint,
                                map: _this.map,
                                draggable: false,
                                zIndex: trackers[i].anchor.properties.zIndex
                            });
                            _this.anchor = poi;
                            bounds.extend(googlePoint);
                            var geoJSON = trackers[i];

                            for(var j = 0; j < geoJSON.zones.features.length; j++){
                                for (var cycle = 0; cycle < geoJSON.zones.features[j].geometry.coordinates[0].length; cycle++) {
                                    var coords = geoJSON.zones.features[j].geometry.coordinates[0];
                                    googlePoint = new google.maps.LatLng(coords[cycle][1], coords[cycle][0]);
                                    bounds.extend(googlePoint);
                                }
                                var zone = geoJSON.zones.features[j];
                                var metadata = zone.properties.googleMaps;
                                var region = new google.maps.Circle({
                                    'center': new google.maps.LatLng(metadata.center[0], metadata.center[1]),
                                    'radius': metadata.radius,
                                    'map': _this.map,
                                    'editable': false,
                                    'fillColor': zone.properties.Color,
                                    'zIndex': metadata.zIndex
                                });
                                _this.zones.push(region);
                            }
                            if (!geoJSON.properties.zoneNamespace) {
                                geoJSON.properties.zoneNamespace = 'default';
                            }

                        }
                        catch (err) {
                            this.fire('message-error', "Issue importing tracker: " + JSON.stringify(data[i]), err);
                        }
                    }
                    googlePoint = new google.maps.LatLng(location.location.geometry.coordinates[1], location.location.geometry.coordinates[0]);
                    var poi;
                    poi = new google.maps.Marker({
                        position: googlePoint,
                        map: _this.map,
                        draggable: false
                    });
                    _this.user = poi;
                    bounds.extend(googlePoint);

                    _this.map.fitBounds(bounds);
                    _this.map.panToBounds(bounds);
                })['catch'](function (error) {
                    console.log('<voyent-locations> Error: ' + ( error.message || error.responseText));
                    console.log(error);
                });
            }
        });
    </script>
</dom-module>
