<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/voyent-web-components/voyent-location-simulator/voyent-location-simulator.html">
<link rel="import" href="../bower_components/voyent-web-components/voyent-location-simulator/voyent-location-route.html">
<link rel="import" href="../bower_components/voyent-web-components/voyent-location-simulator/voyent-location-simulations.html">
<link rel="import" href="../bower_components/voyent-web-components/voyent-transport-editor/voyent-transport-editor.html">
<link rel="import" href="shared-styles.html">

<dom-module id="dashboard-view">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }
        </style>

        <paper-tabs selected="{{selectedTab}}" no-bar>
            <paper-tab>Map</paper-tab>
            <paper-tab>Message Templates</paper-tab>
        </paper-tabs>
        <iron-pages selected="{{selectedTab}}">
            <div class="tab-content">
                <voyent-location-simulator id="simulator">
                    <voyent-location-simulations></voyent-location-simulations>
                    <voyent-location-route></voyent-location-route>
                </voyent-location-simulator>
            </div>
            <div class="tab-content">
                <paper-dropdown-menu horizontal-align="left" label="Incidents:">
                    <iron-selector class="dropdown-content" attr-for-selected="name" selected="{{tracker}}">
                        <template is="dom-repeat" items="{{trackers}}">
                            <div name="{{item._id}}">{{item.properties.zoneNamespace}}</div>
                        </template>
                    </iron-selector>
                </paper-dropdown-menu>
                <template is="dom-if" if="{{tracker}}">
                    <paper-dropdown-menu horizontal-align="left" label="Zones:">
                        <iron-selector class="dropdown-content" attr-for-selected="name" selected="{{zone}}">
                            <template is="dom-repeat" items="{{zones}}">
                                <div name="{{item.properties.zoneId}}">{{item.properties.zoneId}}</div>
                            </template>
                        </iron-selector>
                    </paper-dropdown-menu>
                </template>
                <voyent-transport-editor id="transportEditor" simple value="{{messageTemplate}}"></voyent-transport-editor>
                <template is="dom-if" if="{{showButtons}}">
                    <paper-button raised on-click="saveTemplate">Save</paper-button>
                    <template is="dom-if" if="{{showDeleteButton}}">
                        <paper-button raised on-click="deleteTemplate">Delete</paper-button>
                    </template>
                    <paper-button raised on-click="clearTemplate">Clear</paper-button>
                </template>
            </div>
        </iron-pages>
    </template>

    <script>
        Polymer({
            is: 'dashboard-view',

            properties: {
                visible: {
                    type: Boolean,
                    observer: '_visibleChanged'
                },
                selectedTab: {
                    type: Number,
                    value: 0,
                    observer: '_tabChanged'
                },
                trackers: {
                    type: Array,
                    value: []
                },
                tracker: {
                    type: String,
                    observer: '_trackerUpdated'
                },
                zones: {
                    type: Array,
                    value: []
                },
                zone: {
                    type: String,
                    observer: '_zoneSelected'
                },
                trackerData: {
                    type: Object,
                    value: function() { return {} }
                },
                messageTemplate: {
                    type: String
                },
                showButtons: {
                    type: Boolean,
                    value: false
                },
                showDeleteButton: {
                    type: Boolean,
                    value: false
                },
                _dataProperty: {
                    type: String,
                    value: 'trackerData'
                }
            },

            ready: function() {
                var _this = this;
                //fetch all the trackers for the realm so we can populate the UI
                this._getTrackers();

                //fetch tracker data that contains associated message templates
                voyent.io.scope.getRealmData({'property': this._dataProperty}).then(function(data) {
                    _this.trackerData = data;
                }).catch(function(error) {
                    if (error.status !== 404) {
                        _this.fire('message-error', 'Failed retrieving message templates');
                        console.error('Failed retrieving message templates:',error);
                    }
                });

                //for an undetermined reason the map renders only as a gray box when navigating to this view when
                //first loading the map on the incident view so for now call resizeMap to workaround the issue
                setTimeout(function() {
                    _this.$.simulator.resizeMap();
                },1000);
            },

            saveTemplate: function() {
                var _this = this;
                var messageTemplate = JSON.parse(this.messageTemplate);
                if (!messageTemplate ||
                    !messageTemplate.global ||
                    !messageTemplate.global.subject) {
                    this.fire('message-error', 'Cannot save: Please enter a subject');
                    return;
                }
                if (!messageTemplate.global.details) {
                    this.fire('message-error', 'Cannot save: Please enter a message');
                    return;
                }
                var data = {};
                //specify the property this way to selectively update the record
                data[this._getScopedPropertyName()] = this.messageTemplate;
                voyent.io.scope.createRealmData({'data': data}).then(function() {
                    if (!_this.trackerData[_this.tracker]) {
                        _this.trackerData[_this.tracker] = {};
                    }
                    _this.trackerData[_this.tracker][_this.zone] = _this.messageTemplate;
                    _this.showDeleteButton = true;
                    _this.fire('message-info', 'Successfully saved message template');
                }).catch(function(error) {
                    _this.fire('message-error', 'Failed saving message template');
                    console.error('Failed saving message template',error);
                });
            },

            deleteTemplate: function() {
                var _this = this;
                voyent.io.scope.deleteRealmData({'property':this._getScopedPropertyName()}).then(function() {
                    _this.messageTemplate = null;
                    delete _this.trackerData[_this.tracker][_this.zone];
                    _this.showDeleteButton = false;
                    _this.fire('message-info', 'Successfully deleted message template');
                }).catch(function(error) {
                    _this.fire('message-error', 'Failed deleting message template');
                    console.error('Failed deleting message template',error);
                });
            },

            clearTemplate: function() {
                this.$.transportEditor.resetSimple();
            },

            _trackerUpdated: function(tracker) {
                //reset the zone and any loaded message template
                this.zone = null;
                this.messageTemplate = null;
                //set the list of zones based on the selected tracker
                this._updateZones();
            },

            _zoneSelected: function() {
                if (!this.tracker || !this.zone) {
                    this.showButtons = false;
                    return;
                }
                this.messageTemplate = null;
                this.showButtons = true;
                //try and load message template from trackerData
                if (!this.trackerData[this.tracker] ||
                    !this.trackerData[this.tracker][this.zone]) {
                    this.fire('message-info', 'No existing message template for ' + this.zone);
                    this.showDeleteButton = false;
                    return;
                }
                this.showDeleteButton = true;

                this.messageTemplate = this.trackerData[this.tracker][this.zone];
                this.fire('message-info', 'Loaded saved message template');
            },

            _tabChanged: function() {
                //update the tracker list each time the message template view is shown
                if (this.selectedTab !== 1) {
                    return;
                }
                this._getTrackers();
            },

            _getScopedPropertyName: function() {
                return this._dataProperty+'.'+this.tracker+'.'+this.zone;
            },

            _getTrackers: function() {
                var _this = this;
                voyent.io.locate.getAllTrackers({}).then(function(trackers) {
                    _this.trackers = trackers;
                    if (_this.tracker) {
                        _this._updateZones();
                    }
                }).catch(function(error) {
                    if (error.status !== 404) {
                        _this.fire('message-error', 'Failed retrieving trackers');
                        console.error('Failed retrieving trackers:',error);
                    }
                });
            },

            _updateZones: function() {
                for (var i=0; i<this.trackers.length; i++) {
                    //check if the selected tracker exists
                    if (this.tracker === this.trackers[i]._id) {
                        this.zones = this.trackers[i].zones.features;
                        //check if the selected zone exists
                        if (this.zone) {
                            for (var j=0; j<this.zones.length; j++) {
                                if (this.zone === this.zones[j].properties.zoneId) {
                                    return;
                                }
                            }
                            //the selected zone was no longer found so reset it
                            this.zone = null;
                        }
                        return;
                    }
                }
                //the selected tracker was no longer found so
                //update the menus and reset the selections
                this.tracker = null;
                this.zone = null;
                this.zones = null;
            },

            _visibleChanged: function(visible,oldVisible) {
                //if the previous visible value was undefined then
                //it means this is the first time the page was loaded
                //so don't call refreshMap since it will be called
                //automatically by the component
                if (visible && typeof oldVisible !== 'undefined') {
                    //refresh the map each time the view is loaded
                    this.$.simulator.refreshMap();
                }
            }
        });
    </script>
</dom-module>
